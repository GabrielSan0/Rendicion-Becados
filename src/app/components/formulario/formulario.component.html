<div class="container mt-4">
  <!-- Header -->
  <header class="d-flex justify-content-between align-items-center mb-4 pb-3 border-bottom">
    <div>
      <h1 class="h3 text-primary mb-1">Rendición de Cuentas</h1>
      <p class="mb-0 text-muted">
        <strong>{{ becado()?.name || 'Becado' }}</strong> | 
        DNI: <strong>{{ becado()?.dni || 'N/A' }}</strong>
      </p>
    </div>
    <button class="btn btn-danger btn-sm" (click)="logout()">
      <i class="bi bi-box-arrow-right"></i> Cerrar Sesión
    </button>
  </header>

  <form [formGroup]="rendicionForm" (ngSubmit)="submitRendicion()">
    <!-- 1. Período -->
    <div class="card mb-3">
      <div class="card-header bg-light">
        <h5 class="mb-0">1. Período del Reporte</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6 mb-2">
            <label class="form-label">Del Día:</label>
            <input type="date" class="form-control" formControlName="fechaInicio" required>
          </div>
          <div class="col-md-6 mb-2">
            <label class="form-label">Al Día:</label>
            <input type="date" class="form-control" formControlName="fechaFin" required>
          </div>
        </div>
      </div>
    </div>

    <!-- 2. Gastos de Movilidad -->
    <div class="card mb-3">
      <div class="card-header bg-light">
        <h5 class="mb-0">2. Gastos de Movilidad</h5>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th width="15%">FECHA</th>
                <th width="25%">RUTA (DEL)</th>
                <th width="25%">RUTA (AL)</th>
                <th width="15%">SOLES</th>
                <th width="15%">EVIDENCIA</th>
                <th width="5%"></th>
              </tr>
            </thead>
            <tbody formArrayName="gastosMovilidad">
              <tr *ngFor="let control of gastosMovilidadArray.controls; let i = index" [formGroupName]="i">
                <td><input type="date" class="form-control form-control-sm" formControlName="fecha" required></td>
                <td><input type="text" class="form-control form-control-sm" formControlName="rutaDel" placeholder="Ej: Chancay" required></td>
                <td><input type="text" class="form-control form-control-sm" formControlName="rutaAl" placeholder="Ej: Senati" required></td>
                <td><input type="number" class="form-control form-control-sm" formControlName="monto" min="0.01" placeholder="0.00" step="0.01" required></td>
                <td>
                  <input type="file" #fileInput (change)="onFileSelected($event, i)" accept="image/*" style="display: none">
                  <div *ngIf="!control.get('evidencia')?.value">
                    <button type="button" class="btn btn-outline-primary btn-sm w-100" (click)="fileInput.click()">
                      <i class="bi bi-camera"></i> Cargar
                    </button>
                  </div>
                  <div *ngIf="control.get('evidencia')?.value" class="text-center">
                    <small class="d-block text-truncate">{{ getFileName(control.get('evidencia')?.value) }}</small>
                    <div class="btn-group btn-group-sm mt-1">
                      <button type="button" class="btn btn-outline-info" (click)="viewImage(control.get('evidencia')?.value)">
                        <i class="bi bi-eye"></i>
                      </button>
                      <button type="button" class="btn btn-outline-danger" (click)="removeImage(i)">
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                  </div>
                </td>
                <td class="text-center">
                  <button type="button" class="btn btn-outline-danger btn-sm" 
                          (click)="removeMovilidad(i)" 
                          [disabled]="gastosMovilidadArray.length <= 1">
                    <i class="bi bi-x-lg"></i>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="card-footer">
          <button type="button" class="btn btn-outline-success btn-sm" (click)="addMovilidad()">
            <i class="bi bi-plus-circle"></i> Añadir Gasto
          </button>
        </div>
      </div>
    </div>

    <!-- 3. Firma del Becado -->
    <div class="card mb-3">
      <div class="card-header bg-light">
        <h5 class="mb-0">3. Firma del Becado</h5>
      </div>
      <div class="card-body">
        <div class="mb-3">
          <label class="form-label">Lugar de la Firma:</label>
          <input type="text" class="form-control" formControlName="lugarFirma" 
                 placeholder="Ej: Huaral, Chancay, Josefa Espinoza" required>
        </div>

        <div class="row">
          <!-- Opción A: Dibujar firma -->
          <div class="col-md-6 mb-3">
            <div class="card h-100">
              <div class="card-header bg-light py-2">
                <h6 class="mb-0"><i class="bi bi-pencil"></i> Opción A: Dibujar Firma</h6>
              </div>
              <div class="card-body text-center">
                <canvas #firmaCanvas 
                        class="signature-canvas mb-2"
                        width="400" 
                        height="150"
                        (mousedown)="startDrawing($event)"
                        (mousemove)="draw($event)"
                        (mouseup)="stopDrawing()"
                        (mouseleave)="stopDrawing()"
                        (touchstart)="startDrawingTouch($event)"
                        (touchmove)="drawTouch($event)"
                        (touchend)="stopDrawing()">
                </canvas>
                <div class="d-flex justify-content-between">
                  <button type="button" class="btn btn-outline-danger btn-sm" (click)="clearFirma()">
                    <i class="bi bi-eraser"></i> Limpiar
                  </button>
                  <small class="text-muted">Firme en el recuadro</small>
                </div>
              </div>
            </div>
          </div>

          <!-- Opción B: Cargar imagen -->
          <div class="col-md-6 mb-3">
            <div class="card h-100">
              <div class="card-header bg-light py-2">
                <h6 class="mb-0"><i class="bi bi-upload"></i> Opción B: Cargar Imagen</h6>
              </div>
              <div class="card-body">
                <div class="alert alert-info py-2">
                  <small><i class="bi bi-info-circle"></i> Medidas recomendadas: 400x150px</small>
                </div>
                <div class="upload-area" (click)="firmaFileInput.click()">
                  <input type="file" #firmaFileInput (change)="onFirmaImageSelected($event)" accept="image/*" style="display: none">
                  
                  <div *ngIf="!rendicionForm.get('firmaImagen')?.value">
                    <i class="bi bi-cloud-upload display-6 text-muted mb-2"></i>
                    <p class="text-muted mb-1">Haga clic para seleccionar</p>
                    <small class="text-muted">PNG, JPG, JPEG</small>
                  </div>
                  
                  <div *ngIf="rendicionForm.get('firmaImagen')?.value">
                    <img [src]="rendicionForm.get('firmaImagen')?.value" class="img-thumbnail mb-2" style="max-height: 100px;">
                    <div class="btn-group btn-group-sm">
                      <button type="button" class="btn btn-outline-info" (click)="viewFirmaImage($event)">
                        <i class="bi bi-eye"></i>
                      </button>
                      <button type="button" class="btn btn-outline-danger" (click)="removeFirmaImage($event)">
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                    <p class="mt-2 mb-0"><small>{{ getFirmaImageName() }}</small></p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Indicador de firma seleccionada -->
        <div *ngIf="getFirmaSeleccionada()" class="firma-seleccionada">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <strong><i class="bi bi-check-circle-fill text-success"></i> Firma seleccionada:</strong>
              <span class="ms-2">{{ getFirmaSeleccionada() }}</span>
            </div>
            <button type="button" class="btn btn-outline-danger btn-sm" (click)="limpiarTodasFirmas()">
              <i class="bi bi-trash"></i> Limpiar Todas
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer con botones -->
    <div class="card">
      <div class="card-body">
        <div class="row align-items-center mb-3">
          <div class="col-md-6">
            <div class="alert alert-primary mb-0 py-2">
              <div class="d-flex justify-content-between align-items-center">
                <strong class="h5 mb-0">TOTAL GASTOS A RENDIR:</strong>
                <span class="h4 mb-0 text-primary">S/ {{ totalGastos() | number:'1.2-2' }}</span>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div *ngIf="rendicionForm.invalid && rendicionForm.touched" class="alert alert-warning py-2">
              <i class="bi bi-exclamation-triangle"></i> Complete todos los campos requeridos.
            </div>
          </div>
        </div>

        <div class="d-grid gap-2">
          <button type="submit" [disabled]="rendicionForm.invalid" class="btn btn-warning btn-lg">
            <i class="bi bi-file-earmark-pdf"></i> GENERAR Y DESCARGAR PDF
          </button>

          <button *ngIf="pdfGenerado" 
                  type="button" 
                  (click)="redirigirAGoogleForms()"
                  class="btn btn-success btn-lg">
            <i class="bi bi-cloud-upload"></i> SUBIR ARCHIVO AL FORMULARIO
          </button>
        </div>

        <!-- Mensaje de estado -->
        <div *ngIf="uploadMessage" class="alert mt-3" 
             [class.alert-success]="uploadSuccess" 
             [class.alert-danger]="!uploadSuccess">
          {{ uploadMessage }}
        </div>
      </div>
    </div>
  </form>
</div>

<!-- Modal para ver imágenes -->
<div *ngIf="selectedImage" class="modal fade show d-block" style="background: rgba(0,0,0,0.8);" (click)="closeImageModal()">
  <div class="modal-dialog modal-dialog-centered" (click)="$event.stopPropagation()">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Evidencia</h5>
        <button type="button" class="btn-close" (click)="closeImageModal()"></button>
      </div>
      <div class="modal-body text-center">
        <img [src]="selectedImage" class="modal-image img-fluid" alt="Evidencia">
      </div>
    </div>
  </div>
</div>